name: CD - Train, Build & Deploy to GKE

on:
  push:
    branches: ["main"]

env:
  IMAGE_BASE: ${{ secrets.LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ secrets.ARTIFACT_REPO }}/iris-api

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§¾ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # ğŸ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ğŸ“¦ Install dependencies for training
      - name: Install dependencies for training
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[gs] mlflow joblib numpy scikit-learn

      # ğŸ“¥ Pull DVC data (if configured)
      - name: Pull DVC data (if configured)
        run: |
          if [ -f ".dvc/config" ]; then
            echo "Pulling dataset using DVC..."
            dvc pull || echo "No DVC remote configured or dataset already present"
          else
            echo "DVC not configured, using dataset from repo."
          fi
      - name: Clean old MLflow runs
        run: |
          rm -rf mlruns artifacts
          mkdir -p mlruns artifacts


      # ğŸ§  Run model training
      - name: Run model training
        run: |
          export HOME=$PWD         
          export MLFLOW_TRACKING_URI="file:./mlruns"
          export MLFLOW_ARTIFACT_ROOT="$PWD/artifacts"
          mkdir -p $MLFLOW_ARTIFACT_ROOT
          python train.py

      # âœ… Check model artifact exists
      - name: Check model artifact exists
        run: |
          if [ ! -f "artifacts/model_1.joblib" ]; then
            echo "âŒ Model artifact missing!"
            ls -la artifacts
            exit 1
          fi
          echo "âœ… Model artifact found."

      # ğŸ” Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # â˜ï¸ Setup gcloud and GKE auth plugin
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          install_components: 'gke-gcloud-auth-plugin'

      # ğŸ³ Configure Docker to use gcloud credential helper
      - name: Configure Docker authentication
        run: |
          gcloud auth configure-docker --quiet ${{ secrets.LOCATION }}-docker.pkg.dev

      # ğŸ—ï¸ Build Docker image
      - name: Build Docker image
        run: |
          IMAGE_TAG=${{ env.IMAGE_BASE }}:v${{ github.run_number }}
          docker build -t "${IMAGE_TAG}" .
          docker tag "${IMAGE_TAG}" "${{ env.IMAGE_BASE }}:latest"

      # ğŸš€ Push Docker image to Google Artifact Registry
      - name: Push Docker image
        run: |
          IMAGE_TAG=${{ env.IMAGE_BASE }}:v${{ github.run_number }}
          docker push "${IMAGE_TAG}"
          docker push "${{ env.IMAGE_BASE }}:latest"

      # ğŸ”§ Get GKE credentials
      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_ZONE_OR_REGION }}
          project_id: ${{ secrets.GCP_PROJECT }}

      # ğŸš¢ Deploy to GKE
      - name: Deploy to GKE
        run: |
          IMAGE_TAG=${{ env.IMAGE_BASE }}:v${{ github.run_number }}
          echo "Deploying image: ${IMAGE_TAG}"

          echo "ğŸ”„ Applying deployment and service manifests..."
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

          echo "ğŸš€ Updating image in deployment..."
          kubectl set image deployment/iris-api iris-api=${IMAGE_TAG} --record || true

          echo "â³ Waiting for rollout to complete..."
          kubectl rollout status deployment/iris-api

          echo "âš™ï¸ Checking if HPA exists..."
          if ! kubectl get hpa iris-api-hpa >/dev/null 2>&1; then
            echo "ğŸ†• HPA not found â€” creating new autoscaler..."
            kubectl apply -f k8s/hpa.yml
          else
            echo "âœ… HPA already exists â€” updating configuration..."
            kubectl apply -f k8s/hpa.yml
          fi

          echo "ğŸ” Verifying HPA status..."
          kubectl get hpa iris-api-hpa || echo "âš ï¸ Could not fetch HPA status."

      # ğŸ§© Apply manifests if first-time deployment
      # - name: Apply manifests (if needed)
      #   if: failure()
      #   run: |
      #     kubectl apply -f k8s/deployment.yaml
      #     kubectl apply -f k8s/service.yaml
      #     kubectl apply -f k8s/hpa.yml
          
      #     kubectl rollout status deployment/iris-api