name: CD - Train, Build & Deploy to GKE

on:
  push:
    branches: ["main"]

env:
  IMAGE_BASE: ${{ secrets.LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ secrets.ARTIFACT_REPO }}/iris-api

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # üßæ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # üêç Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # üì¶ Install dependencies for training
      - name: Install dependencies for training
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[gs] mlflow joblib numpy scikit-learn

      # üì• Pull DVC data (if configured)
      - name: Pull DVC data (if configured)
        run: |
          if [ -f ".dvc/config" ]; then
            echo "Pulling dataset using DVC..."
            dvc pull || echo "No DVC remote configured or dataset already present"
          else
            echo "DVC not configured, using dataset from repo."
          fi

      # üß† Run model training
      - name: Run model training
        run: |
          export HOME=$PWD         
          export MLFLOW_TRACKING_URI="file:./mlruns"
          export MLFLOW_ARTIFACT_ROOT="$PWD/mlartifacts"
          mkdir -p $MLFLOW_ARTIFACT_ROOT
          python train.py

      # ‚úÖ Check model artifact exists
      - name: Check model artifact exists
        run: |
          if [ ! -f "artifacts/model.joblib" ]; then
            echo "‚ùå Model artifact missing!"
            ls -la artifacts
            exit 1
          fi
          echo "‚úÖ Model artifact found."

      # üîê Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # ‚òÅÔ∏è Setup gcloud and GKE auth plugin
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          install_components: 'gke-gcloud-auth-plugin'

      # üê≥ Configure Docker to use gcloud credential helper
      - name: Configure Docker authentication
        run: |
          gcloud auth configure-docker --quiet ${{ secrets.LOCATION }}-docker.pkg.dev

      # üèóÔ∏è Build Docker image
      - name: Build Docker image
        run: |
          IMAGE_TAG=${{ env.IMAGE_BASE }}:v${{ github.run_number }}
          docker build -t "${IMAGE_TAG}" .
          docker tag "${IMAGE_TAG}" "${{ env.IMAGE_BASE }}:latest"

      # üöÄ Push Docker image to Google Artifact Registry
      - name: Push Docker image
        run: |
          IMAGE_TAG=${{ env.IMAGE_BASE }}:v${{ github.run_number }}
          docker push "${IMAGE_TAG}"
          docker push "${{ env.IMAGE_BASE }}:latest"

      # üîß Get GKE credentials
      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_ZONE_OR_REGION }}
          project_id: ${{ secrets.GCP_PROJECT }}

      # üö¢ Deploy to GKE
      - name: Deploy to GKE
        run: |
          IMAGE_TAG=${{ env.IMAGE_BASE }}:v${{ github.run_number }}
          echo "Deploying image: ${IMAGE_TAG}"
          kubectl set image deployment/iris-api iris-api=${IMAGE_TAG} --record || true
          kubectl rollout status deployment/iris-api

      # üß© Apply manifests if first-time deployment
      - name: Apply manifests (if needed)
        if: failure()
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl rollout status deployment/iris-api