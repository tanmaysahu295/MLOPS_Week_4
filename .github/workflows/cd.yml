name: CD - Train, Build & Deploy to GKE

on:
  push:
    branches: ["main"]

env:
  IMAGE_BASE: ${{ secrets.LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ secrets.ARTIFACT_REPO }}/iris-api

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps for training
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[gs] mlflow joblib numpy scikit-learn

      - name: Pull DVC data (if configured)
        run: |
          if [ -f ".dvc/config" ]; then
            dvc pull || echo "No DVC remote configured"
          fi

      - name: Run training to produce model artifact
        run: |
          python train.py
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || '' }}

      - name: Check model artifact exists
        run: |
          if [ ! -f "artifacts/model.joblib" ]; then
            echo "Model artifact missing!"
            ls -la
            exit 1
          fi

      - name: Configure GCP auth (OIDC recommended)
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GCP_OIDC_PROVIDER_ID }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          install_components: 'gke-gcloud-auth-plugin'

      - name: Configure docker to use gcloud credential helper
        run: |
          gcloud auth configure-docker --quiet ${{ secrets.LOCATION }}-docker.pkg.dev

      - name: Build Docker image
        run: |
          IMAGE_TAG=${{ env.IMAGE_BASE }}:${{ github.sha }}
          docker build -t "${IMAGE_TAG}" .
          docker tag "${IMAGE_TAG}" "${{ env.IMAGE_BASE }}:latest"

      - name: Push Docker image
        run: |
          IMAGE_TAG=${{ env.IMAGE_BASE }}:${{ github.sha }}
          docker push "${IMAGE_TAG}"
          docker push "${{ env.IMAGE_BASE }}:latest"

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_ZONE_OR_REGION }}
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: Deploy to GKE (apply manifests & set image)
        run: |
          IMAGE_TAG=${{ env.IMAGE_BASE }}:${{ github.sha }}
          sed -i "s|LOCATION-docker.pkg.dev/PROJECT/REPO/iris-api:latest|${IMAGE_TAG}|g" k8s/deployment.yaml || true
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl -n default set image deployment/iris-api iris-api=${IMAGE_TAG} --record || true
